var assert = require('assert')
var OverpassFrontend = require('../src/OverpassFrontend')

let overpassFrontend

describe('Load OSM data from XML file created with "out body geom" from Overpass API', function () {
  it ('.osm', function (done) {
    this.timeout(20000)
    overpassFrontend = new OverpassFrontend('test/body-geom.osm')
    overpassFrontend.once('load', (meta) => {
      done()
    })
  })

  it('node', (done) => {
    let count = 0

    overpassFrontend.get(
      ['n7717702652'],
      {},
      (err, result) => {
        count++
        const geojson = result.GeoJSON()
        assert.equal(result.properties, OverpassFrontend.ALL)
        assert.deepEqual(geojson, {
          "type": "Feature",
          "id": "node/7717702652",
          "properties": {
            "@id": "node/7717702652"
          },
          "geometry": {
            "type": "Point",
            "coordinates": [
              16.3373586,
              48.1286986
            ]
          }
        })
      },
      (err) => {
        assert.equal(count, 1, "No object found")
        done(err)
      }
    )
  })

  it('node (referenced object)', (done) => {
    let count = 0

    overpassFrontend.get(
      ['n4332664312'],
      {
        properties: OverpassFrontend.ID_ONLY
      },
      (err, result) => {
        count++
        const geojson = result.GeoJSON()
        assert.equal(result.properties, OverpassFrontend.CENTER|OverpassFrontend.GEOM|OverpassFrontend.BBOX)
        assert.deepEqual(geojson, {
          "type": "Feature",
          "id": "node/4332664312",
          "properties": {
            "@id": "node/4332664312"
          },
          "geometry": {
            "type": "Point",
            "coordinates": [
              16.3474235,
              48.131152
            ]
          }
        })
      },
      (err) => {
        assert.equal(count, 1, "No object found")
        done(err)
      }
    )
  })

  it('way', (done) => {
    let count = 0

    overpassFrontend.get(
      ['w73502758'],
      {},
      (err, result) => {
        count++
        assert.equal(result.properties, OverpassFrontend.ALL)
        const geojson = result.GeoJSON()
        assert.deepEqual(geojson, {
          "type": "Feature",
          "id": "way/73502758",
          "properties": {
            "@id": "way/73502758",
            "highway": "track",
            "source": "geoimage.at",
            "surface": "dirt",
            "tracktype": "grade4",
            "@osm3s:version": 0.6,
            "@osm3s:generator": "Overpass API 0.7.56.9 76e5016d",
            "@osm3s:copyright": "The data included in this document is from www.openstreetmap.org. The data is made available under ODbL.",
            "@osm3s:timestamp_osm_base": "2021-08-28T13:58:14Z",
            "@osm3s:bounds": {
              "minlon": 16.2978237,
              "minlat": 48.1252236,
              "maxlon": 16.4194459,
              "maxlat": 48.1389998
            }
          },
          "geometry": {
            "type": "LineString",
            "coordinates": [
              [
                16.3362288,
                48.1261387
              ],
              [
                16.3385904,
                48.1312234
              ],
              [
                16.3386462,
                48.1312791
              ],
              [
                16.3387121,
                48.1313111
              ]
            ]
          }
        })
      },
      (err) => {
        assert.equal(count, 1, "No object found")
        done(err)
      }
    )
  })

  it('way (referenced object)', (done) => {
    let count = 0

    overpassFrontend.get(
      ['w771273963'],
      {
        properties: OverpassFrontend.ID_ONLY
      },
      (err, result) => {
        count++
        const geojson = result.GeoJSON()
        assert.equal(result.properties, OverpassFrontend.GEOM|OverpassFrontend.BBOX|OverpassFrontend.CENTER)
        assert.deepEqual(geojson, {
          "type": "Feature",
          "id": "way/771273963",
          "properties": {
            "@id": "way/771273963"
          },
          "geometry": {
            "type": "LineString",
            "coordinates": [
              [
                16.3440996,
                48.1318708
              ],
              [
                16.3440728,
                48.131835
              ],
              [
                16.3441291,
                48.1317974
              ],
              [
                16.3442901,
                48.1317706
              ],
              [
                16.3445476,
                48.131767
              ],
              [
                16.3446924,
                48.1317563
              ],
              [
                16.3447648,
                48.1317885
              ],
              [
                16.3448158,
                48.1318189
              ],
              [
                16.344797,
                48.1318404
              ],
              [
                16.3446951,
                48.1318386
              ],
              [
                16.34451,
                48.131835
              ],
              [
                16.3443276,
                48.1318458
              ],
              [
                16.3440996,
                48.1318708
              ]
            ]
          }
        })
      },
      (err) => {
        assert.equal(count, 1, "No object found")
        done(err)
      }
    )
  })

  it('relation', (done) => {
    let count = 0

    overpassFrontend.get(
      ['r11308701'],
      {},
      (err, result) => {
        count++
        assert.equal(result.properties, OverpassFrontend.ALL)
        const geojson = result.GeoJSON()
        assert.deepEqual(geojson, {
          "type": "Feature",
          "id": "relation/11308701",
          "properties": {
            "@id": "relation/11308701",
            "natural": "grassland",
            "type": "multipolygon",
            "@osm3s:version": 0.6,
            "@osm3s:generator": "Overpass API 0.7.56.9 76e5016d",
            "@osm3s:timestamp_osm_base": "2021-08-28T13:58:14Z",
            "@osm3s:copyright": "The data included in this document is from www.openstreetmap.org. The data is made available under ODbL.",
            "@osm3s:bounds": {
              "minlon": 16.2978237,
              "minlat": 48.1252236,
              "maxlon": 16.4194459,
              "maxlat": 48.1389998
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  16.3499203,
                  48.1327113
                ],
                [
                  16.3479017,
                  48.1331723
                ],
                [
                  16.3475637,
                  48.1332358
                ],
                [
                  16.3472861,
                  48.13326
                ],
                [
                  16.3468784,
                  48.1332528
                ],
                [
                  16.3463763,
                  48.1332692
                ],
                [
                  16.3462924,
                  48.1328607
                ],
                [
                  16.346382,
                  48.1327546
                ],
                [
                  16.3465324,
                  48.132646
                ],
                [
                  16.3467455,
                  48.1324974
                ],
                [
                  16.3467104,
                  48.1324428
                ],
                [
                  16.3468084,
                  48.1323836
                ],
                [
                  16.3468738,
                  48.132315
                ],
                [
                  16.3469275,
                  48.1322355
                ],
                [
                  16.3469415,
                  48.132167
                ],
                [
                  16.3469369,
                  48.1320844
                ],
                [
                  16.3469135,
                  48.1319987
                ],
                [
                  16.3468458,
                  48.1318615
                ],
                [
                  16.346694,
                  48.1315997
                ],
                [
                  16.346645,
                  48.1315124
                ],
                [
                  16.3466287,
                  48.1314485
                ],
                [
                  16.3466263,
                  48.1313737
                ],
                [
                  16.3466287,
                  48.1312958
                ],
                [
                  16.3466263,
                  48.1312569
                ],
                [
                  16.34661,
                  48.1312413
                ],
                [
                  16.3465773,
                  48.1312397
                ],
                [
                  16.3465423,
                  48.1312771
                ],
                [
                  16.3464072,
                  48.1313161
                ],
                [
                  16.3458544,
                  48.1313776
                ],
                [
                  16.3457867,
                  48.1315626
                ],
                [
                  16.3457331,
                  48.1316184
                ],
                [
                  16.3452712,
                  48.1318042
                ],
                [
                  16.3449258,
                  48.1319066
                ],
                [
                  16.3448775,
                  48.1318744
                ],
                [
                  16.3447112,
                  48.1318834
                ],
                [
                  16.3444027,
                  48.1319031
                ],
                [
                  16.3441774,
                  48.1319424
                ],
                [
                  16.3434318,
                  48.1320284
                ],
                [
                  16.3435578,
                  48.1321555
                ],
                [
                  16.3426331,
                  48.13227
                ],
                [
                  16.3420514,
                  48.1323028
                ],
                [
                  16.3413718,
                  48.1323041
                ],
                [
                  16.3413906,
                  48.132177
                ],
                [
                  16.3412672,
                  48.132168
                ],
                [
                  16.3408271,
                  48.1322089
                ],
                [
                  16.3407958,
                  48.1321497
                ],
                [
                  16.3407361,
                  48.1318873
                ],
                [
                  16.3406316,
                  48.1316624
                ],
                [
                  16.3405508,
                  48.1315185
                ],
                [
                  16.3404126,
                  48.1314105
                ],
                [
                  16.3402239,
                  48.1313183
                ],
                [
                  16.3400049,
                  48.1312621
                ],
                [
                  16.3397892,
                  48.1312419
                ],
                [
                  16.3398013,
                  48.1312102
                ],
                [
                  16.339756,
                  48.1311616
                ],
                [
                  16.3395592,
                  48.1311787
                ],
                [
                  16.339392,
                  48.1312128
                ],
                [
                  16.3390476,
                  48.1313481
                ],
                [
                  16.3387485,
                  48.1314912
                ],
                [
                  16.3386816,
                  48.1315398
                ],
                [
                  16.3385773,
                  48.1315832
                ],
                [
                  16.3382762,
                  48.1316357
                ],
                [
                  16.3381916,
                  48.1316357
                ],
                [
                  16.3381109,
                  48.1316475
                ],
                [
                  16.3380912,
                  48.131662
                ],
                [
                  16.3380537,
                  48.131671
                ],
                [
                  16.3380246,
                  48.131631
                ],
                [
                  16.3378622,
                  48.131631
                ],
                [
                  16.3372621,
                  48.131465
                ],
                [
                  16.336504,
                  48.1311932
                ],
                [
                  16.3369845,
                  48.1313196
                ],
                [
                  16.3371203,
                  48.13117
                ],
                [
                  16.3375378,
                  48.1313253
                ],
                [
                  16.3376326,
                  48.1313401
                ],
                [
                  16.3376931,
                  48.1312539
                ],
                [
                  16.337679,
                  48.1311718
                ],
                [
                  16.3370203,
                  48.1294528
                ],
                [
                  16.3360015,
                  48.1274352
                ],
                [
                  16.3357133,
                  48.126782
                ],
                [
                  16.3356237,
                  48.1267616
                ],
                [
                  16.3331509,
                  48.1270372
                ],
                [
                  16.3336202,
                  48.1269056
                ],
                [
                  16.3329932,
                  48.1269308
                ],
                [
                  16.3327204,
                  48.1269047
                ],
                [
                  16.3325973,
                  48.1268514
                ],
                [
                  16.3323983,
                  48.1266014
                ],
                [
                  16.3326869,
                  48.126626
                ],
                [
                  16.3329146,
                  48.1265735
                ],
                [
                  16.3329496,
                  48.1266474
                ],
                [
                  16.3361791,
                  48.1261134
                ],
                [
                  16.3361939,
                  48.1262232
                ],
                [
                  16.3361285,
                  48.1262214
                ],
                [
                  16.3360316,
                  48.1262406
                ],
                [
                  16.3364635,
                  48.1271194
                ],
                [
                  16.3368194,
                  48.1278653
                ],
                [
                  16.3372905,
                  48.1288995
                ],
                [
                  16.337513,
                  48.1293729
                ],
                [
                  16.3377407,
                  48.1298655
                ],
                [
                  16.338128,
                  48.1306446
                ],
                [
                  16.338429,
                  48.1313119
                ],
                [
                  16.3385677,
                  48.1312857
                ],
                [
                  16.3387121,
                  48.1313111
                ],
                [
                  16.3388749,
                  48.131273
                ],
                [
                  16.3392142,
                  48.1311733
                ],
                [
                  16.3394404,
                  48.1311301
                ],
                [
                  16.33965,
                  48.1311155
                ],
                [
                  16.345016,
                  48.1310017
                ],
                [
                  16.34532,
                  48.1309775
                ],
                [
                  16.3453992,
                  48.1310008
                ],
                [
                  16.3457258,
                  48.1310046
                ],
                [
                  16.3465042,
                  48.1311163
                ],
                [
                  16.3472149,
                  48.1311667
                ],
                [
                  16.3474235,
                  48.131152
                ],
                [
                  16.3476407,
                  48.1311083
                ],
                [
                  16.3476906,
                  48.1312128
                ],
                [
                  16.3472879,
                  48.1314049
                ],
                [
                  16.3474255,
                  48.1316756
                ],
                [
                  16.3479161,
                  48.1316501
                ],
                [
                  16.3478494,
                  48.13169
                ],
                [
                  16.3477126,
                  48.1317205
                ],
                [
                  16.3474551,
                  48.1317437
                ],
                [
                  16.3473263,
                  48.1317402
                ],
                [
                  16.3472915,
                  48.1317276
                ],
                [
                  16.34727,
                  48.1316936
                ],
                [
                  16.3472271,
                  48.131699
                ],
                [
                  16.3472512,
                  48.1317563
                ],
                [
                  16.3473746,
                  48.1317733
                ],
                [
                  16.3475229,
                  48.1317671
                ],
                [
                  16.3478735,
                  48.1317312
                ],
                [
                  16.3482812,
                  48.1316471
                ],
                [
                  16.3490805,
                  48.1314752
                ],
                [
                  16.3495177,
                  48.1313624
                ],
                [
                  16.3499203,
                  48.1327113
                ]
              ],
              [
                [
                  16.3379113,
                  48.1315691
                ],
                [
                  16.337979,
                  48.131465
                ],
                [
                  16.3379525,
                  48.1314473
                ],
                [
                  16.3378406,
                  48.131465
                ],
                [
                  16.3378009,
                  48.1314286
                ],
                [
                  16.337689,
                  48.1314326
                ],
                [
                  16.3374387,
                  48.1313942
                ],
                [
                  16.3374063,
                  48.1314561
                ],
                [
                  16.3374638,
                  48.1314954
                ],
                [
                  16.3376331,
                  48.1315338
                ],
                [
                  16.3376772,
                  48.1315269
                ],
                [
                  16.3377641,
                  48.1315613
                ],
                [
                  16.3379113,
                  48.1315691
                ]
              ],
              [
                [
                  16.3408515,
                  48.1313606
                ],
                [
                  16.3410419,
                  48.1313589
                ],
                [
                  16.3411465,
                  48.1313463
                ],
                [
                  16.3411975,
                  48.1312962
                ],
                [
                  16.3412485,
                  48.1312282
                ],
                [
                  16.3412699,
                  48.131187
                ],
                [
                  16.3412029,
                  48.131178
                ],
                [
                  16.3410151,
                  48.1311727
                ],
                [
                  16.3408381,
                  48.1311977
                ],
                [
                  16.3407308,
                  48.1312103
                ],
                [
                  16.3407147,
                  48.1312497
                ],
                [
                  16.3407335,
                  48.1312729
                ],
                [
                  16.3407925,
                  48.1312837
                ],
                [
                  16.3407952,
                  48.1313159
                ],
                [
                  16.3408515,
                  48.1313606
                ]
              ],
              [
                [
                  16.3418171,
                  48.1314018
                ],
                [
                  16.3419673,
                  48.1314251
                ],
                [
                  16.342037,
                  48.1313964
                ],
                [
                  16.3420692,
                  48.1312604
                ],
                [
                  16.3419861,
                  48.1312335
                ],
                [
                  16.3419351,
                  48.1312514
                ],
                [
                  16.3417983,
                  48.1312407
                ],
                [
                  16.3417849,
                  48.1312819
                ],
                [
                  16.3418251,
                  48.1312998
                ],
                [
                  16.3417956,
                  48.1313445
                ],
                [
                  16.3418171,
                  48.1314018
                ]
              ],
              [
                [
                  16.3416454,
                  48.1317455
                ],
                [
                  16.3417634,
                  48.1317688
                ],
                [
                  16.3419271,
                  48.1317688
                ],
                [
                  16.3420692,
                  48.1317491
                ],
                [
                  16.3421792,
                  48.1317455
                ],
                [
                  16.3422596,
                  48.1317509
                ],
                [
                  16.3423911,
                  48.1317187
                ],
                [
                  16.3424233,
                  48.1316972
                ],
                [
                  16.3424098,
                  48.1316865
                ],
                [
                  16.3423428,
                  48.1316865
                ],
                [
                  16.3421148,
                  48.1317097
                ],
                [
                  16.3419029,
                  48.1317151
                ],
                [
                  16.3417366,
                  48.1317151
                ],
                [
                  16.3416508,
                  48.1317115
                ],
                [
                  16.3416454,
                  48.1317455
                ]
              ],
              [
                [
                  16.342214,
                  48.1318673
                ],
                [
                  16.3421309,
                  48.1319049
                ],
                [
                  16.3421255,
                  48.1319532
                ],
                [
                  16.3421309,
                  48.1319675
                ],
                [
                  16.3421577,
                  48.131955
                ],
                [
                  16.3422221,
                  48.1319496
                ],
                [
                  16.3422865,
                  48.1319424
                ],
                [
                  16.3423482,
                  48.1319317
                ],
                [
                  16.3423991,
                  48.1319496
                ],
                [
                  16.342442,
                  48.1319407
                ],
                [
                  16.3424581,
                  48.131912
                ],
                [
                  16.3423294,
                  48.1318708
                ],
                [
                  16.342214,
                  48.1318673
                ]
              ],
              [
                [
                  16.3426647,
                  48.1319192
                ],
                [
                  16.3426647,
                  48.1320695
                ],
                [
                  16.3428578,
                  48.1320481
                ],
                [
                  16.3430053,
                  48.1320105
                ],
                [
                  16.3429892,
                  48.131921
                ],
                [
                  16.3430724,
                  48.1318977
                ],
                [
                  16.3430241,
                  48.1318673
                ],
                [
                  16.3429785,
                  48.1318798
                ],
                [
                  16.3429409,
                  48.1319299
                ],
                [
                  16.3428739,
                  48.1319371
                ],
                [
                  16.3428336,
                  48.1319228
                ],
                [
                  16.3428095,
                  48.1318959
                ],
                [
                  16.3426647,
                  48.1319192
                ]
              ],
              [
                [
                  16.3425976,
                  48.1314931
                ],
                [
                  16.3426191,
                  48.1316954
                ],
                [
                  16.3426566,
                  48.1318028
                ],
                [
                  16.3427317,
                  48.1318225
                ],
                [
                  16.3428283,
                  48.1318225
                ],
                [
                  16.3429034,
                  48.1317974
                ],
                [
                  16.3429973,
                  48.1316865
                ],
                [
                  16.3429463,
                  48.1316489
                ],
                [
                  16.3429087,
                  48.1316435
                ],
                [
                  16.342831,
                  48.1317437
                ],
                [
                  16.3427693,
                  48.1317527
                ],
                [
                  16.3427451,
                  48.1317402
                ],
                [
                  16.3427183,
                  48.1315898
                ],
                [
                  16.342729,
                  48.1315056
                ],
                [
                  16.3427022,
                  48.1314645
                ],
                [
                  16.3426405,
                  48.1314537
                ],
                [
                  16.3425976,
                  48.1314931
                ]
              ],
              [
                [
                  16.3436115,
                  48.131178
                ],
                [
                  16.3436168,
                  48.1314161
                ],
                [
                  16.3436115,
                  48.1315558
                ],
                [
                  16.3436678,
                  48.1315701
                ],
                [
                  16.3436544,
                  48.1316381
                ],
                [
                  16.3436839,
                  48.1316542
                ],
                [
                  16.3437107,
                  48.1316238
                ],
                [
                  16.3436678,
                  48.1311601
                ],
                [
                  16.3436544,
                  48.1311476
                ],
                [
                  16.3436115,
                  48.131178
                ]
              ],
              [
                [
                  16.3428068,
                  48.1312622
                ],
                [
                  16.3432601,
                  48.1312192
                ],
                [
                  16.3433754,
                  48.1311082
                ],
                [
                  16.3427719,
                  48.1311422
                ],
                [
                  16.342662,
                  48.1311619
                ],
                [
                  16.3428068,
                  48.1312622
                ]
              ],
              [
                [
                  16.3431931,
                  48.1315253
                ],
                [
                  16.3431931,
                  48.1317258
                ],
                [
                  16.3432226,
                  48.1317616
                ],
                [
                  16.3432977,
                  48.1317813
                ],
                [
                  16.3434827,
                  48.1317813
                ],
                [
                  16.3435954,
                  48.1318046
                ],
                [
                  16.3438743,
                  48.1318619
                ],
                [
                  16.3439333,
                  48.1318565
                ],
                [
                  16.3439548,
                  48.1318315
                ],
                [
                  16.3439199,
                  48.1317777
                ],
                [
                  16.343869,
                  48.1317688
                ],
                [
                  16.3437268,
                  48.1317545
                ],
                [
                  16.3436142,
                  48.1317258
                ],
                [
                  16.3435256,
                  48.1317097
                ],
                [
                  16.3433245,
                  48.1317133
                ],
                [
                  16.3433084,
                  48.1316829
                ],
                [
                  16.3432789,
                  48.1316668
                ],
                [
                  16.3432655,
                  48.1314949
                ],
                [
                  16.3431931,
                  48.1315253
                ]
              ],
              [
                [
                  16.343987,
                  48.1310796
                ],
                [
                  16.3441291,
                  48.1312156
                ],
                [
                  16.3441935,
                  48.1312246
                ],
                [
                  16.344333,
                  48.1312103
                ],
                [
                  16.3444403,
                  48.1311297
                ],
                [
                  16.3445288,
                  48.1311906
                ],
                [
                  16.3445824,
                  48.1312031
                ],
                [
                  16.3447461,
                  48.1311924
                ],
                [
                  16.344797,
                  48.1311297
                ],
                [
                  16.3448587,
                  48.1311064
                ],
                [
                  16.3449392,
                  48.1311691
                ],
                [
                  16.3449687,
                  48.1311852
                ],
                [
                  16.345135,
                  48.1311834
                ],
                [
                  16.345261,
                  48.1313034
                ],
                [
                  16.3453415,
                  48.1313553
                ],
                [
                  16.3454166,
                  48.1313213
                ],
                [
                  16.3453978,
                  48.1312926
                ],
                [
                  16.3453549,
                  48.1313034
                ],
                [
                  16.3453066,
                  48.1312693
                ],
                [
                  16.3452342,
                  48.1312085
                ],
                [
                  16.3451752,
                  48.131153
                ],
                [
                  16.3451967,
                  48.1311029
                ],
                [
                  16.3452262,
                  48.1310778
                ],
                [
                  16.3452208,
                  48.1310563
                ],
                [
                  16.3450572,
                  48.1310509
                ],
                [
                  16.3449043,
                  48.1310509
                ],
                [
                  16.3446039,
                  48.1310671
                ],
                [
                  16.3443893,
                  48.1310778
                ],
                [
                  16.343987,
                  48.1310796
                ]
              ],
              [
                [
                  16.3440996,
                  48.1318708
                ],
                [
                  16.3443276,
                  48.1318458
                ],
                [
                  16.34451,
                  48.131835
                ],
                [
                  16.3446951,
                  48.1318386
                ],
                [
                  16.344797,
                  48.1318404
                ],
                [
                  16.3448158,
                  48.1318189
                ],
                [
                  16.3447648,
                  48.1317885
                ],
                [
                  16.3446924,
                  48.1317563
                ],
                [
                  16.3445476,
                  48.131767
                ],
                [
                  16.3442901,
                  48.1317706
                ],
                [
                  16.3441291,
                  48.1317974
                ],
                [
                  16.3440728,
                  48.131835
                ],
                [
                  16.3440996,
                  48.1318708
                ]
              ]
            ]
          }
        })
      },
      (err) => {
        assert.equal(count, 1, "No object found")
        done(err)
      }
    )
  })
})
