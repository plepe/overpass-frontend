<html>
<head>
  <meta charset="utf-8">
  <title>OverpassFrontendFrontend DEMO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../node_modules/leaflet/dist/leaflet.css" />
  <style>
.leaflet-popup-content {
  max-height: 250px;
  overflow: auto;
}
.leaflet-popup-content pre {
  font-size: 8px;
}
#map {
  position: absolute;
  left: 250px; top: 0; bottom: 0; right: 0;
}
#sidebar {
  position: absolute;
  width: 250px; top: 0; bottom: 0; left: 0;
  padding: 0.25em;
  border-right: 1px solid black;
  box-sizing: border-box;
}
#form > * {
  display: block;
}
#form > input[type=text] {
  width: 100%;
}
#form > textarea,
textarea#result {
  width: 100%;
  height: 20em;
}
  </style>
  <script src="../node_modules/leaflet/dist/leaflet.js"></script>
  <script src="../dist/overpass-frontend.js"></script>
  <script type='text/javascript'>
var map
var overpass
var request
var current_objects = {}
var form
var formValues = {}

function check_update_map () {
  var bounds = new BoundingBox(map.getBounds())

  // Hide loaded but non-visible objects
  for (var k in current_objects) {
    var ob = current_objects[k]

    if (!ob.intersects(bounds)) {
      map.removeLayer(ob.feature)
      delete(current_objects[k])
    }
  }

  // Abort current requests (in case they are long-lasting - we don't need them
  // anyway). Data which is being submitted will still be loaded to the cache.
  if (request) {
    request.abort()
  }

  // Query all trees in the current view
  request = overpass.BBoxQuery(form.elements.query.value, bounds,
    {
      properties: OverpassFrontend.ALL
    },
    function (err, ob) {
      if (!ob.feature) {
        ob.feature = ob.leafletFeature({
          nodeFeature: 'CircleMarker',
          color: 'red',
          fillColor: 'red',
          fillOpacity: 0.1,
          weight: 2,
          radius: 6
        })
        ob.feature.bindPopup('<pre>' + JSON.stringify(ob.GeoJSON(), null, '  ').replace(/\&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>')
      }
      
      ob.feature.addTo(map)
      current_objects[ob.id] = ob
    },
    function (err) {
    }
  )

  const codeDisplay = document.getElementById('result')
  if (codeDisplay) {
    let code = 'const OverpassFrontend = require(\'overpass-frontend\')\n'
    code += 'const overpassFrontend = new OverpassFrontend(' + JSON.stringify(form.elements.url.value) + ')\n\n'

    const options = {
      properties: OverpassFrontend.ALL
    }
    code += 'const request = overpassFrontend.BBoxQuery(\n' +
      indent(JSON.stringify(form.elements.query.value)) + ',\n' +
      indent(JSON.stringify(bounds, null, '  ')) + ',\n' +
      indent(JSON.stringify(options, null, '  ')) + ',\n' +
      '  (err, feature) => console.log(feature.id, feature.tags),\n' +
      '  (err) => console.error(err)\n)'


    codeDisplay.value = code
  }
}

function clear_map () {
  for (var k in current_objects) {
    map.removeLayer(current_objects[k].feature)
  }
  current_objects = {}
}

window.onload = function() {
  map = L.map('map').setView([51.505, -0.09], 18)

  var osm_mapnik = L.tileLayer('//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }
  )
  osm_mapnik.addTo(map)

  form = document.getElementById('form')
  form.onsubmit = () => update()
  update()

  map.on('moveend', check_update_map)
  check_update_map()
}

function update () {
  clear_map()

  if (!overpass || form.elements.url.value !== formValues.url) {
    overpass = new OverpassFrontend(form.elements.url.value)
    overpass.once('load', (data) => {
      if (data.bounds) {
        map.fitBounds(data.bounds.toLeaflet())
      }
    })
  }

  formValues = {
    url: form.elements.url.value
  }

  check_update_map()
  return false
}

function indent (str) {
  return '  ' + str.split(/\n/g).join('\n  ')
}
  </script>
</head>
<body>
  <div id='map'></div>
  <div id='sidebar'>
    <form id='form'>
      Overpass API URL / URL of .osm(.bz2) file:<br/>
      <input type='text' name='url' value='//www.overpass-api.de/api/interpreter'><br/>
      Query:<br/>
      <textarea name="query">nwr[natural=tree];</textarea><br/>
      <input type='submit' value='Change query'>
    </form>

    Resulting code:
    <textarea id="result"></textarea>
  </div>
</body>
</html>
